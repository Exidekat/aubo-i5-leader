<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual Robot Visualization - SO-100 & AUBO i5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            overflow: hidden;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        /* Main visualization area */
        #viz-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Top status bar */
        #status-bar {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-bottom: 2px solid #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #status-bar h1 {
            font-size: 20px;
            color: #4CAF50;
        }

        .status-item {
            display: inline-block;
            margin: 0 15px;
            font-size: 14px;
        }

        .status-label {
            color: #87CEEB;
            margin-right: 5px;
        }

        .status-value {
            color: #FFD700;
            font-weight: bold;
        }

        /* Dual robot canvas area */
        #canvas-area {
            flex: 1;
            display: flex;
        }

        .robot-panel {
            flex: 1;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .robot-panel.so100 {
            border-right: 2px solid #2196F3;
        }

        .robot-panel.aubo {
            border-left: 2px solid #FF9800;
        }

        .robot-canvas {
            width: 100%;
            height: 100%;
        }

        .robot-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            pointer-events: none;
        }

        .robot-label.so100 {
            color: #2196F3;
            border: 2px solid #2196F3;
        }

        .robot-label.aubo {
            color: #FF9800;
            border: 2px solid #FF9800;
        }

        .robot-label .subtitle {
            font-size: 11px;
            color: #87CEEB;
            font-weight: normal;
            margin-top: 2px;
        }

        /* Right sidebar */
        #sidebar {
            width: 350px;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid #4CAF50;
        }

        .section {
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .section-title.so100 {
            color: #2196F3;
        }

        .section-title.aubo {
            color: #FF9800;
        }

        .section-title.system {
            color: #4CAF50;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            color: #87CEEB;
        }

        .data-value {
            color: #FFD700;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .joint-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .joint-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .joint-name {
            color: #87CEEB;
            font-size: 10px;
            margin-bottom: 3px;
        }

        .joint-angle {
            color: #FFD700;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        #connection-status {
            text-align: center;
            padding: 12px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 5px;
            font-size: 13px;
            margin-bottom: 15px;
        }

        .loading {
            color: #FFD700;
            animation: pulse 1.5s infinite;
        }

        .connected {
            color: #4CAF50;
        }

        .error {
            color: #f44336;
            background: rgba(244, 67, 54, 0.2);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            margin-top: 10px;
        }

        button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #4CAF50;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        .mode-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .mode-idle {
            background: #757575;
        }

        .mode-test {
            background: #2196F3;
        }

        .mode-demo {
            background: #FF9800;
        }

        .mode-real {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Main visualization area -->
        <div id="viz-container">
            <!-- Status bar -->
            <div id="status-bar">
                <h1>ü§ñ Dual-Arm Robot Control System</h1>
                <div>
                    <span class="status-item">
                        <span class="status-label">Mode:</span>
                        <span class="status-value" id="system-mode">
                            <span class="mode-badge mode-idle">IDLE</span>
                        </span>
                    </span>
                    <span class="status-item">
                        <span class="status-label">Updates:</span>
                        <span class="status-value" id="update-count">0</span>
                    </span>
                    <span class="status-item">
                        <span class="status-label">IK Success:</span>
                        <span class="status-value" id="ik-success">0.0%</span>
                    </span>
                </div>
            </div>

            <!-- Dual robot canvas -->
            <div id="canvas-area">
                <!-- SO-100 Leader (Left) -->
                <div class="robot-panel so100">
                    <canvas id="so100-canvas" class="robot-canvas"></canvas>
                    <div class="robot-label so100">
                        üîµ SO-100 LEADER
                        <div class="subtitle">5-DOF | 450mm reach</div>
                    </div>
                </div>

                <!-- AUBO i5 Follower (Right) -->
                <div class="robot-panel aubo">
                    <canvas id="aubo-canvas" class="robot-canvas"></canvas>
                    <div class="robot-label aubo">
                        üü† AUBO i5 FOLLOWER
                        <div class="subtitle">6-DOF | 886mm reach</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right sidebar -->
        <div id="sidebar">
            <div id="connection-status" class="loading">
                Connecting to server...
            </div>

            <!-- System Status -->
            <div class="section">
                <div class="section-title system">‚öôÔ∏è System Status</div>
                <div class="data-row">
                    <span class="data-label">Workspace Scale:</span>
                    <span class="data-value">1.97x</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Update Rate:</span>
                    <span class="data-value" id="update-rate">0 Hz</span>
                </div>
                <div class="data-row">
                    <span class="data-label">IK Successes:</span>
                    <span class="data-value" id="ik-stats">0 / 0</span>
                </div>
            </div>

            <!-- SO-100 State -->
            <div class="section">
                <div class="section-title so100">üîµ SO-100 Leader</div>

                <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: #87CEEB; margin-bottom: 6px;">Joint Angles (degrees)</div>
                    <div class="joint-grid" id="so100-joints">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div style="font-size: 12px; color: #87CEEB; margin-bottom: 6px;">End Effector Position (m)</div>
                <div class="data-row">
                    <span class="data-label">X:</span>
                    <span class="data-value" id="so100-ee-x">0.000</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Y:</span>
                    <span class="data-value" id="so100-ee-y">0.000</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Z:</span>
                    <span class="data-value" id="so100-ee-z">0.000</span>
                </div>

                <div style="margin-top: 12px;">
                    <div class="data-row">
                        <span class="data-label">Gripper:</span>
                        <span class="data-value" id="so100-gripper">0.00</span>
                    </div>
                </div>
            </div>

            <!-- AUBO i5 State -->
            <div class="section">
                <div class="section-title aubo">üü† AUBO i5 Follower</div>

                <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: #87CEEB; margin-bottom: 6px;">Joint Angles (degrees)</div>
                    <div class="joint-grid" id="aubo-joints">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div style="font-size: 12px; color: #87CEEB; margin-bottom: 6px;">End Effector Position (m)</div>
                <div class="data-row">
                    <span class="data-label">X:</span>
                    <span class="data-value" id="aubo-ee-x">0.000</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Y:</span>
                    <span class="data-value" id="aubo-ee-y">0.000</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Z:</span>
                    <span class="data-value" id="aubo-ee-z">0.000</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Three.js library -->
    <script src="/static/three.min.js"></script>
    <script src="/static/OrbitControls.js"></script>

    <script>
        // ============================================
        // Dual Robot Visualization with Three.js
        // ============================================

        // Global variables
        let so100Scene, so100Camera, so100Renderer, so100Controls;
        let auboScene, auboCamera, auboRenderer, auboControls;
        let so100Robot = { joints: [], links: [], ee: null };
        let auboRobot = { joints: [], links: [], ee: null };
        let updateRateHistory = [];
        let lastUpdateTime = Date.now();

        // Joint names
        const so100JointNames = ['Shoulder_Rot', 'Shoulder_Pitch', 'Elbow',
                                 'Wrist_Pitch', 'Wrist_Roll', 'Gripper'];
        const auboJointNames = ['Shoulder', 'Upper_Arm', 'Fore_Arm',
                               'Wrist_1', 'Wrist_2', 'Wrist_3'];

        // ============================================
        // Initialize 3D scenes
        // ============================================
        function initScenes() {
            // SO-100 Scene (Left)
            initSO100Scene();

            // AUBO i5 Scene (Right)
            initAUBOScene();

            // Start animation loops
            animateSO100();
            animateAUBO();
        }

        function initSO100Scene() {
            const canvas = document.getElementById('so100-canvas');
            const width = canvas.parentElement.clientWidth;
            const height = canvas.parentElement.clientHeight;

            // Scene
            so100Scene = new THREE.Scene();
            so100Scene.background = new THREE.Color(0x1a1a2e);

            // Camera
            so100Camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 10);
            so100Camera.position.set(0.8, 0.6, 0.8);
            so100Camera.lookAt(0, 0.2, 0);

            // Renderer
            so100Renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            so100Renderer.setSize(width, height);
            so100Renderer.setPixelRatio(window.devicePixelRatio);

            // Controls
            so100Controls = new THREE.OrbitControls(so100Camera, canvas);
            so100Controls.target.set(0, 0.2, 0);
            so100Controls.enableDamping = true;
            so100Controls.dampingFactor = 0.05;

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            so100Scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(1, 1, 1);
            so100Scene.add(dirLight);

            // Grid
            const gridHelper = new THREE.GridHelper(1, 10, 0x2196F3, 0x444444);
            so100Scene.add(gridHelper);

            // Axes
            const axesHelper = new THREE.AxesHelper(0.3);
            so100Scene.add(axesHelper);

            // Create robot visualization
            createSO100Robot();

            // Handle window resize
            window.addEventListener('resize', () => {
                const width = canvas.parentElement.clientWidth;
                const height = canvas.parentElement.clientHeight;
                so100Camera.aspect = width / height;
                so100Camera.updateProjectionMatrix();
                so100Renderer.setSize(width, height);
            });
        }

        function initAUBOScene() {
            const canvas = document.getElementById('aubo-canvas');
            const width = canvas.parentElement.clientWidth;
            const height = canvas.parentElement.clientHeight;

            // Scene
            auboScene = new THREE.Scene();
            auboScene.background = new THREE.Color(0x1a1a2e);

            // Camera
            auboCamera = new THREE.PerspectiveCamera(50, width / height, 0.1, 10);
            auboCamera.position.set(1.5, 1.2, 1.5);
            auboCamera.lookAt(0, 0.4, 0);

            // Renderer
            auboRenderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            auboRenderer.setSize(width, height);
            auboRenderer.setPixelRatio(window.devicePixelRatio);

            // Controls
            auboControls = new THREE.OrbitControls(auboCamera, canvas);
            auboControls.target.set(0, 0.4, 0);
            auboControls.enableDamping = true;
            auboControls.dampingFactor = 0.05;

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            auboScene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(1, 1, 1);
            auboScene.add(dirLight);

            // Grid
            const gridHelper = new THREE.GridHelper(2, 20, 0xFF9800, 0x444444);
            auboScene.add(gridHelper);

            // Axes
            const axesHelper = new THREE.AxesHelper(0.3);
            auboScene.add(axesHelper);

            // Create robot visualization
            createAUBORobot();

            // Handle window resize
            window.addEventListener('resize', () => {
                const width = canvas.parentElement.clientWidth;
                const height = canvas.parentElement.clientHeight;
                auboCamera.aspect = width / height;
                auboCamera.updateProjectionMatrix();
                auboRenderer.setSize(width, height);
            });
        }

        function createSO100Robot() {
            // Create 6 joints (5 + gripper) as spheres
            const jointGeometry = new THREE.SphereGeometry(0.02, 16, 16);
            const jointMaterial = new THREE.MeshPhongMaterial({ color: 0x2196F3, emissive: 0x2196F3, emissiveIntensity: 0.3 });

            for (let i = 0; i < 6; i++) {
                const joint = new THREE.Mesh(jointGeometry, jointMaterial);
                so100Scene.add(joint);
                so100Robot.joints.push(joint);
            }

            // Create 5 links as cylinders
            for (let i = 0; i < 5; i++) {
                const link = new THREE.Group();
                so100Scene.add(link);
                so100Robot.links.push(link);
            }

            // End effector marker
            const eeGeometry = new THREE.SphereGeometry(0.03, 16, 16);
            const eeMaterial = new THREE.MeshPhongMaterial({ color: 0x00ff00, emissive: 0x00ff00, emissiveIntensity: 0.5 });
            so100Robot.ee = new THREE.Mesh(eeGeometry, eeMaterial);
            so100Scene.add(so100Robot.ee);
        }

        function createAUBORobot() {
            // Create 6 joints as spheres
            const jointGeometry = new THREE.SphereGeometry(0.03, 16, 16);
            const jointMaterial = new THREE.MeshPhongMaterial({ color: 0xFF9800, emissive: 0xFF9800, emissiveIntensity: 0.3 });

            for (let i = 0; i < 6; i++) {
                const joint = new THREE.Mesh(jointGeometry, jointMaterial);
                auboScene.add(joint);
                auboRobot.joints.push(joint);
            }

            // Create 6 links
            for (let i = 0; i < 6; i++) {
                const link = new THREE.Group();
                auboScene.add(link);
                auboRobot.links.push(link);
            }

            // End effector marker
            const eeGeometry = new THREE.SphereGeometry(0.04, 16, 16);
            const eeMaterial = new THREE.MeshPhongMaterial({ color: 0x00ff00, emissive: 0x00ff00, emissiveIntensity: 0.5 });
            auboRobot.ee = new THREE.Mesh(eeGeometry, eeMaterial);
            auboScene.add(auboRobot.ee);
        }

        // ============================================
        // Update robot visualizations
        // ============================================
        function updateSO100Visualization(data) {
            if (!data.joint_positions || data.joint_positions.length === 0) return;

            // Update joint positions
            data.joint_positions.forEach((pos, i) => {
                if (i < so100Robot.joints.length) {
                    so100Robot.joints[i].position.set(pos[0], pos[2], -pos[1]);
                }
            });

            // Update links (cylinders between joints)
            for (let i = 0; i < so100Robot.links.length && i < data.joint_positions.length - 1; i++) {
                const start = data.joint_positions[i];
                const end = data.joint_positions[i + 1];

                const link = so100Robot.links[i];
                link.clear();

                const startVec = new THREE.Vector3(start[0], start[2], -start[1]);
                const endVec = new THREE.Vector3(end[0], end[2], -end[1]);
                const direction = new THREE.Vector3().subVectors(endVec, startVec);
                const length = direction.length();

                if (length > 0.001) {
                    const geometry = new THREE.CylinderGeometry(0.015, 0.015, length, 8);
                    const material = new THREE.MeshPhongMaterial({ color: 0x2196F3, transparent: true, opacity: 0.7 });
                    const cylinder = new THREE.Mesh(geometry, material);

                    cylinder.position.copy(startVec).add(direction.multiplyScalar(0.5));
                    cylinder.quaternion.setFromUnitVectors(
                        new THREE.Vector3(0, 1, 0),
                        direction.normalize()
                    );

                    link.add(cylinder);
                }
            }

            // Update end effector
            if (data.end_effector_pos) {
                const pos = data.end_effector_pos;
                so100Robot.ee.position.set(pos[0], pos[2], -pos[1]);
            }

            // Update UI
            updateSO100UI(data);
        }

        function updateAUBOVisualization(data) {
            if (!data.joint_positions || data.joint_positions.length === 0) return;

            // Update joint positions
            data.joint_positions.forEach((pos, i) => {
                if (i < auboRobot.joints.length) {
                    auboRobot.joints[i].position.set(pos[0], pos[2], -pos[1]);
                }
            });

            // Update links
            for (let i = 0; i < auboRobot.links.length && i < data.joint_positions.length - 1; i++) {
                const start = data.joint_positions[i];
                const end = data.joint_positions[i + 1];

                const link = auboRobot.links[i];
                link.clear();

                const startVec = new THREE.Vector3(start[0], start[2], -start[1]);
                const endVec = new THREE.Vector3(end[0], end[2], -end[1]);
                const direction = new THREE.Vector3().subVectors(endVec, startVec);
                const length = direction.length();

                if (length > 0.001) {
                    const geometry = new THREE.CylinderGeometry(0.02, 0.02, length, 8);
                    const material = new THREE.MeshPhongMaterial({ color: 0xFF9800, transparent: true, opacity: 0.7 });
                    const cylinder = new THREE.Mesh(geometry, material);

                    cylinder.position.copy(startVec).add(direction.multiplyScalar(0.5));
                    cylinder.quaternion.setFromUnitVectors(
                        new THREE.Vector3(0, 1, 0),
                        direction.normalize()
                    );

                    link.add(cylinder);
                }
            }

            // Update end effector
            if (data.end_effector_pos) {
                const pos = data.end_effector_pos;
                auboRobot.ee.position.set(pos[0], pos[2], -pos[1]);
            }

            // Update UI
            updateAUBOUI(data);
        }

        // ============================================
        // Update UI elements
        // ============================================
        function updateSO100UI(data) {
            // Joint angles
            const jointsDiv = document.getElementById('so100-joints');
            jointsDiv.innerHTML = '';
            data.joint_angles.forEach((angle, i) => {
                const degrees = (angle * 180 / Math.PI).toFixed(1);
                jointsDiv.innerHTML += `
                    <div class="joint-item">
                        <div class="joint-name">${so100JointNames[i]}</div>
                        <div class="joint-angle">${degrees}¬∞</div>
                    </div>
                `;
            });

            // End effector
            if (data.end_effector_pos) {
                document.getElementById('so100-ee-x').textContent = data.end_effector_pos[0].toFixed(3);
                document.getElementById('so100-ee-y').textContent = data.end_effector_pos[1].toFixed(3);
                document.getElementById('so100-ee-z').textContent = data.end_effector_pos[2].toFixed(3);
            }

            // Gripper
            if (data.gripper_state !== undefined) {
                document.getElementById('so100-gripper').textContent = data.gripper_state.toFixed(2);
            }
        }

        function updateAUBOUI(data) {
            // Joint angles
            const jointsDiv = document.getElementById('aubo-joints');
            jointsDiv.innerHTML = '';
            data.joint_angles.forEach((angle, i) => {
                const degrees = (angle * 180 / Math.PI).toFixed(1);
                jointsDiv.innerHTML += `
                    <div class="joint-item">
                        <div class="joint-name">${auboJointNames[i]}</div>
                        <div class="joint-angle">${degrees}¬∞</div>
                    </div>
                `;
            });

            // End effector
            if (data.end_effector_pos) {
                document.getElementById('aubo-ee-x').textContent = data.end_effector_pos[0].toFixed(3);
                document.getElementById('aubo-ee-y').textContent = data.end_effector_pos[1].toFixed(3);
                document.getElementById('aubo-ee-z').textContent = data.end_effector_pos[2].toFixed(3);
            }
        }

        function updateSystemStatus(data) {
            // Mode
            const modeBadge = document.getElementById('system-mode').querySelector('.mode-badge');
            modeBadge.textContent = data.mode.toUpperCase();
            modeBadge.className = `mode-badge mode-${data.mode}`;

            // Update count
            document.getElementById('update-count').textContent = data.update_count;

            // IK success rate
            document.getElementById('ik-success').textContent = data.ik_success_rate.toFixed(1) + '%';
            document.getElementById('ik-stats').textContent = `${data.ik_successes} / ${data.ik_total}`;

            // Calculate update rate
            const now = Date.now();
            const dt = (now - lastUpdateTime) / 1000;
            if (dt > 0) {
                const rate = 1 / dt;
                updateRateHistory.push(rate);
                if (updateRateHistory.length > 10) {
                    updateRateHistory.shift();
                }
                const avgRate = updateRateHistory.reduce((a, b) => a + b, 0) / updateRateHistory.length;
                document.getElementById('update-rate').textContent = avgRate.toFixed(1) + ' Hz';
            }
            lastUpdateTime = now;
        }

        // ============================================
        // Animation loops
        // ============================================
        function animateSO100() {
            requestAnimationFrame(animateSO100);
            so100Controls.update();
            so100Renderer.render(so100Scene, so100Camera);
        }

        function animateAUBO() {
            requestAnimationFrame(animateAUBO);
            auboControls.update();
            auboRenderer.render(auboScene, auboCamera);
        }

        // ============================================
        // Data fetching
        // ============================================
        async function fetchData() {
            try {
                // Fetch SO-100 state
                const so100Response = await fetch('/api/so100_state');
                const so100Data = await so100Response.json();
                updateSO100Visualization(so100Data);

                // Fetch AUBO state
                const auboResponse = await fetch('/api/aubo_state');
                const auboData = await auboResponse.json();
                updateAUBOVisualization(auboData);

                // Fetch system status
                const statusResponse = await fetch('/api/system_status');
                const statusData = await statusResponse.json();
                updateSystemStatus(statusData);

                // Update connection status
                const statusDiv = document.getElementById('connection-status');
                statusDiv.textContent = '‚úì Connected';
                statusDiv.className = 'connected';

            } catch (error) {
                console.error('Error fetching data:', error);
                const statusDiv = document.getElementById('connection-status');
                statusDiv.textContent = '‚úó Connection Error';
                statusDiv.className = 'error';
            }
        }

        // ============================================
        // Initialize on page load
        // ============================================
        window.addEventListener('load', () => {
            initScenes();

            // Start data fetching loop
            setInterval(fetchData, 100);  // 10 Hz
            fetchData();  // Initial fetch
        });
    </script>
</body>
</html>
